{% extends "dashboard/layout.html" %}

{% block title %}Books - Library Management System{% endblock %}

{% block dashboard_content %}
<div class="books-page">
    <div class="page-header">
        <h1 class="page-title">Books Catalog</h1>
        {% if session.user_role == 'admin' %}
        <a href="{{ url_for('add_book') }}" class="add-button">Add New Book</a>
        {% endif %}
    </div>

    <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="searchInput" class="search-input" placeholder="Search books by title, author, or ISBN...">
    </div>

    <div class="table-container">
        <table class="data-table" id="booksTable">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Author</th>
                    <th>ISBN</th>
                    <th>Genre</th>
                    <th>Status</th>
                    {% if session.user_role == 'admin' %}
                    <th>Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% if books|length == 0 %}
                <tr>
                    <td colspan="{% if session.user_role == 'admin' %}6{% else %}5{% endif %}" class="empty-table">No books found</td>
                </tr>
                {% else %}
                {% for book in books %}
                <tr>
                    <td class="book-title">{{ book.title }}</td>
                    <td>{{ book.author }}</td>
                    <td>{{ book.isbn }}</td>
                    <td>{{ book.genre or 'N/A' }}</td>
                    <td>
                        {% if book.id in issued_book_ids %}
                        <span class="badge red">Issued</span>
                        {% else %}
                        <span class="badge green">Available</span>
                        {% endif %}
                    </td>
                    {% if session.user_role == 'admin' %}
                    <td>
                        <div class="dropdown">
                            <button class="dropdown-button">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <div class="dropdown-content">
                                <a href="{{ url_for('edit_book', book_id=book.id) }}" class="dropdown-item">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                                <form action="{{ url_for('delete_book', book_id=book.id) }}" method="POST" class="delete-form">
                                    <button type="submit" class="dropdown-item delete">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block dashboard_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Search functionality
        const searchInput = document.getElementById('searchInput');
        const table = document.getElementById('booksTable');
        const rows = table.getElementsByTagName('tr');
        
        searchInput.addEventListener('keyup', function() {
            const term = searchInput.value.toLowerCase();
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.getElementsByTagName('td');
                
                if (cells.length === 0) continue; // Skip empty rows
                
                let found = false;
                for (let j = 0; j < 4; j++) { // Search in title, author, ISBN, genre
                    if (cells[j].textContent.toLowerCase().indexOf(term) > -1) {
                        found = true;
                        break;
                    }
                }
                
                row.style.display = found ? '' : 'none';
            }
        });
        
        // Delete confirmation
        const deleteForms = document.querySelectorAll('.delete-form');
        deleteForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                if (!confirm('Are you sure you want to delete this book?')) {
                    e.preventDefault();
                }
            });
        });
        
        // Dropdown menu
        const dropdownButtons = document.querySelectorAll('.dropdown-button');
        dropdownButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Close all other dropdowns
                document.querySelectorAll('.dropdown-content').forEach(content => {
                    if (content !== this.nextElementSibling) {
                        content.classList.remove('show');
                    }
                });
                
                // Toggle current dropdown
                this.nextElementSibling.classList.toggle('show');
            });
        });
        
        // Close dropdowns when clicking outside
        window.addEventListener('click', function(e) {
            if (!e.target.matches('.dropdown-button') && !e.target.matches('.fa-ellipsis-h')) {
                document.querySelectorAll('.dropdown-content').forEach(content => {
                    content.classList.remove('show');
                });
            }
        });
    });
</script>
{% endblock %}
